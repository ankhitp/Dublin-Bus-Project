function initMap() {    var pos;    directionsService = new google.maps.DirectionsService();    directionsDisplay = new google.maps.DirectionsRenderer();    // The location of Dublin    var dublin = {lat: 53.33306, lng: -6.24889};    // The map, centered at Uluru    var im = {        url: '../static/img/userLoc.png', // url        scaledSize: new google.maps.Size(40, 40), // scaled size        origin: new google.maps.Point(0, 0), // origin        anchor: new google.maps.Point(0, 0) // anchor    };    map = new google.maps.Map(document.getElementById('map'), {        zoom: 14,        center: dublin,        mapTypeControl: false,    });    directionsDisplay.setMap(map);    //uses the Google geolocation service    if (navigator.geolocation) {        navigator.geolocation.getCurrentPosition(function (position) {            pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);            var marker = new google.maps.Marker({                position: pos,                map: map,                icon: im            });            map.setCenter(pos);        });    }    autocompSearchBar();    setAutocomplete();    // The marker, positioned at Uluru    addMarker(map);}/** * This function sets up the autocomplete for the origin and destination fields */function setAutocomplete() {    var originInput = document.getElementById('origin-input');    var destinationInput = document.getElementById('destination-input');    //define a center and circle for our autocomplete search, this makes it so that it's biased toward this area when    //searching for a place name    var center = new google.maps.LatLng(53.33306, -6.24889);    var circle = new google.maps.Circle({        center: center,        radius: 10000    });    //setting up the autcomplete and adding the bound circle of 10KM for suggestions    var originAutocomplete = new google.maps.places.Autocomplete(originInput);    var destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);    originAutocomplete.setBounds(circle.getBounds());    destinationAutocomplete.setBounds(circle.getBounds());    this.setupPlaceChangedListener(originAutocomplete, 'ORIG');    this.setupPlaceChangedListener(destinationAutocomplete, 'DEST');    var marker = new google.maps.Marker({position: dublin, map: map});}/** * This sets up the main search bar's autocomplete */function autocompSearchBar() {    var infowindow = new google.maps.InfoWindow();    var input = document.getElementById('pac-input');    var searchBox = new google.maps.places.SearchBox(input);    map.addListener('bounds_changed', function () {        searchBox.setBounds(map.getBounds());    });    // Listen for the event fired when the user selects a prediction and retrieve    // more details for that place.    searchBox.addListener('places_changed', function () {        var places = searchBox.getPlaces();        if (places.length == 0) {            return;        }        // Clear out the old markers.        markers.forEach(function (marker) {            marker.setMap(null);        });        newMarkers = [];        // For each place, get the icon, name and location.        var bounds = new google.maps.LatLngBounds();        places.forEach(function (place) {            if (!place.geometry) {                console.log("Returned place contains no geometry");                return;            }            var icon = {                url: place.icon,                size: new google.maps.Size(142, 142),                origin: new google.maps.Point(0, 0),                anchor: new google.maps.Point(17, 34),                scaledSize: new google.maps.Size(50, 50)            };            var location = document.getElementById("pac-input").value;            myMark = new google.maps.Marker({                map: map,                icon: icon,                title: place.name,                position: place.geometry.location,                content: '<button onclick = "routeToHere(\'' + location + '\')" class = "btn-primary">Route to here</button></div>'            });            // Create a marker for each place.            newMarkers.push(myMark);            if (place.geometry.viewport) {                // Only geocodes have viewport.                bounds.union(place.geometry.viewport);            } else {                bounds.extend(place.geometry.location);            }            google.maps.event.addListener(myMark, 'click', (function (myMark) {                return function () {                    infowindow.setContent(myMark.content);                    infowindow.open(map, myMark);                }            })(myMark));        });        map.fitBounds(bounds);    });}function addMarker(map) {    for (var i = 0, length = data.length; i < length; i++) {        var busdata = data[i];        var myLatLng = {lat: parseFloat(busdata.stop_lat), lng: parseFloat(busdata.stop_lon)};        // Creating  markers and putting it on the map        // {#var image = 'https://image.flaticon.com/icons/svg/164/164955.svg';#}        // {#var image = "{% static '../../static/img/bus.png' %}";#}        var marker = new google.maps.Marker({            position: myLatLng,            map: map,            title: busdata.actual_stop_id + "\n" + busdata.stop_name,            // {#icon: image,#}        });    }}/** * Sets the starting point to the marker clicked * @param data is the name of the station clicked on */function routeFromHere(data) {    document.getElementById('origin-input').value = data;}/** * Routes from the current location of the user to the selected marker * * @param location which is the location of the stop */function routeToHere(location) {    var pos;    if (navigator.geolocation) {        navigator.geolocation.getCurrentPosition(function (position) {            pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);            map.setCenter(pos);            var geocoder = new google.maps.Geocoder;            var lat = position.coords.latitude;            var long = position.coords.longitude;            var latlngStr = lat.toString() + "," + long.toString();            latlngStr = latlngStr.split(',', 2);            var latlng = {lat: parseFloat(latlngStr[0]), lng: parseFloat(latlngStr[1])};            geocoder.geocode({'location': latlng}, function (results, status) {                if (status === 'OK') {                    var start = results[0].formatted_address;                    getLatLng(start, location);                } else {                    alert("Something went wrong. Try again!")                }            });        }, function () {            handleLocationError(true, LocationWindow, map.getCenter());        });    } else {        // Browser doesn't support Geolocation        handleLocationError(false, LocationWindow, map.getCenter());    }    function handleLocationError(browserHasGeolocation, LocationWindow, pos) {        LocationWindow.setPosition(pos);        LocationWindow.setContent(browserHasGeolocation ?            'Error: The Geolocation service failed.' :            'Error: Your browser doesn\'t support geolocation.');        LocationWindow.open(map);    }}//removes line created for routefunction removeLine() {    for (var i = 0; i < polylines.length; ++i) {        polylines[i].setMap(null);    }    polylines = [];    return false;}function clearMarkers() {    setMapOnAll(null);}function setMapOnAll(map) {    for (var i = 0; i < markers.length; i++) {        markers[i].setMap(map);    }}//CALL THIS TO REMOVE MARKERS FROM MAP, IT USES THE OTHER MARKER RELATED FUNCTIONS!function deleteMarkers() {    clearMarkers();    markers = [];}//sets the map back to original position, resets the side bar to the 'search dublin' optionfunction resetMap() {    document.getElementById('directions').style.display = "none";    document.getElementById('coTwo').innerHTML = "";    document.getElementById('options').style.width = '300px';    document.getElementById('options').style.height = "300px";    document.getElementById('options').innerHTML =        "<div id = 'journeyPlan' style = 'display:none'>" +        "            <h3 style=\"text-align: center\">Start your journey here!</h3>" +        "            <br>" +        "            <h4 style=\"text-align: center\">Enter a start and end location!</h4>" +        "" +        "            <div style=\"text-align: center\">" +        "" +        "                <input autocomplete=\"off\" class=\"controls\" id=\"origin-input\" placeholder=\"Enter an origin location\"" +        "                       type=\"text\">" +        "" +        "                <input autocomplete=\"off\" class=\"controls\" id=\"destination-input\" placeholder=\"Enter a destination location\"" +        "                       type=\"text\">" +        "" +        "            </div>" +        "            <br>" +        "            <div style=\"text-align: center\">" +        "                <button class='btn btn-primary' id=\"directionsButton\" onclick=\"buildDateTime()\" type=\"submit\">Next" +        "                </button>" +        "            </div>" +        "            <br>" +        "            <div style=\"text-align: center\">" +        "                <button class='btn btn-primary' id=\"locationButton\" onclick=\"findLocation()\" type=\"submit\">Find Stations" +        "                    Near Me!" +        "                </button>" +        "            </div>" +        "            <br>" +        "            <br>" +        "            <br>" +        "            <div style=\"text-align: center\">" +        "                <button class='btn btn-primary' onclick=\"hideOptions()\" type=\"submit\">Hide Options ^</button>" +        "            </div>" +        "            </div>" +        "       <div id = 'timeDate' style = 'display:none'>" +        "            <div style = 'text-align: center'>" +        "                <input style = 'width:250px' class='controls' id='dateField' name='daterange' type='text' >" +        "                <input style = 'width:250px' class='controls' autocomplete='off' id='timepicker1' placeholder='Please select a time' type='text'>" +        "                <button class='btn btn-primary' id=\"directionsButton2\" onclick=\"resizeMap()\" type=\"submit\">Search</button>" +        "            </div> " +        "        </div>" +        "        <div id = 'searchOnly' style = 'display:block'>" +        "            <div style=\"text-align: center\">" +        "            <h3>Search for a place in Dublin to visit!</h3>" +        "                <input autocomplete=\"off\" class=\"controls\" id=\"pac-input\" placeholder=\"Search Dublin\" type=\"text\" autocomplete = 'off'>" +        "                <br>" +        "                <br>" +        "                <button class='btn btn-primary' onclick=\"showOptions()\" type=\"submit\">Show Journey Planner</button>" +        "            </div>" +        "</div>";    calendarBuilder();    $(function () {        $('#timepicker1').timepicker({            dynamic: false,            dropdown: true,            scrollbar: true,            step: 30,        })    });    var currentDate = new Date();    var endDate = new Date();    var numberOfDaysToAdd = 4;    currentDate.setDate(currentDate.getDate() + 1);    endDate.setDate(currentDate.getDate() + numberOfDaysToAdd);    function calendarBuilder() {        $('input[name="daterange"]').daterangepicker({            singleDatePicker: true,            showDropdowns: true,            minDate: currentDate,            maxDate: endDate        })    }    autocompSearchBar();    setAutocomplete();}//resizes map for directions on the right sidefunction resizeMap() {    var start = document.getElementById('origin-input').value;    var end = document.getElementById('destination-input').value;    var time = document.getElementById('dateField').value;    var date = document.getElementById('timepicker1').value;    deleteMarkers();    if (start == "" || end == "") {        document.getElementById("options").innerHTML = "<h4 style = 'text-align: center'>Please enter a start and end location!</h4>" +            "<div style = 'text-align: center'>" +            "<br> <br> <button class='btn btn-primary' id = 'directionsButton'  type='submit' onclick = 'resetMap()'>Try Again</button> " +            "</div>";    } else {        document.getElementById('options').style.width = "500px";        getLatLng(start, end, time, date);    }}//resizes map for directions on the right sidefunction mobileResizeMap() {    deleteMarkers();    var start = document.getElementById('origin-input').value;    var end = document.getElementById('destination-input').value;    var time = document.getElementById('dateField').value;    var date = document.getElementById('timepicker1').value;    if (start == "" || end == "") {        document.getElementById("header").innerHTML = "<h4 style = 'text-align: center'>Please enter a start and end location!</h4>" +            "<div style = 'text-align: center'>" +            "<br> <br> <button class='btn btn-primary' id = 'directionsButton'  type='submit' onclick = 'createHeader(); setAutocomplete()'>Try Again</button> " +            "</div>";    } else {        document.getElementById('header').innerHTML =            "<div style = 'text-align: center'>" +            "            <input autocomplete=\"off\" class=\"controls\" id=\"origin-input\"" +            "                   placeholder=\"Enter an origin location\" type=\"text\">" +            "        </div>" +            "        <div style = 'text-align: center'>" +            "            <input autocomplete=\"off\" class=\"controls\" id=\"destination-input\"" +            "                   placeholder=\"Enter a destination location\" type=\"text\" >" +            "        </div>" +                "<div style = 'text-align: center'>" +            "            <input style = 'width:150px' class=\"controls\" id='dateField' name='daterange' type='text''/>" +            "            <input style = 'width:150px' class=\"controls\" autocomplete=\"off\" id=\"timepicker1\" placeholder=\"Please select a time\" type=\"text\">" +            "    </div>" +            "    <br>";        document.getElementById('origin-input').value = start;        document.getElementById('destination-input').value = end;        document.getElementById('routes').style.display = 'block';        mobileGetLatLng(start, end, time, date);    }    $(document).ready(function () {        calendarBuilder();        $(function () {            $('#mytimepick').timepicker({                dynamic: false,                dropdown: true,                scrollbar: true,                step: 15,            })        })    });    var currentDate = new Date();    var endDate = new Date();    var numberOfDaysToAdd = 4;    currentDate.setDate(currentDate.getDate() + 1);    endDate.setDate(currentDate.getDate() + numberOfDaysToAdd);    function calendarBuilder() {        $('input[name="daterange"]').daterangepicker({            singleDatePicker: true,            showDropdowns: true,            minDate: currentDate,            maxDate: endDate        })    }}function mobileResetMap() {    document.getElementById('routes').style.display = 'none';    document.getElementById('map').style.display = 'block';    createHeader();    setAutocomplete();}function createHeader() {    document.getElementById('header').innerHTML =        '<div id = "header" class = "col-12">' +        '    <h3 style="text-align: center">Start your journey here</h3>' +        '    <br>' +        '    <h4 style="text-align: center">Enter a start and end location</h4>' +        '    <div style = \'text-align: center\'>' +        '        <input autocomplete="off" class="controls" id="origin-input"' +        '               placeholder="Enter an origin location" type="text" onchange ="placeMarker(1, document.getElementById(\'origin-input\').value)">' +        '    </div>' +        '    <div style = \'text-align: center\'>' +        '        <input autocomplete="off" class="controls" id="destination-input"' +        '               placeholder="Enter a destination location" type="text" onchange ="placeMarker(2, document.getElementById(\'destination-input\').value); ">' +        '    </div' +        "<div style = 'text-align: center'>" +        "            <input style = 'width:150px' class=\"controls\" id='dateField' name='daterange' type='text''/>" +        "            <input style = 'width:150px' class=\"controls\" autocomplete=\"off\" id=\"timepicker1\" placeholder=\"Please select a time\" type=\"text\">" +        "    </div>" +        "    <br>" +        '    <div style="text-align: center">' +        '        <button class=\'btn btn-primary\' id="directionsButton" onclick="mobileResizeMap()" type="submit">Search' +        '        </button>' +        '    </div>' +        '</div>';    $(document).ready(function () {        calendarBuilder();        $(function () {            $('#mytimepick').timepicker({                dynamic: false,                dropdown: true,                scrollbar: true,                step: 15,            })        })    });    var currentDate = new Date();    var endDate = new Date();    var numberOfDaysToAdd = 4;    currentDate.setDate(currentDate.getDate() + 1);    endDate.setDate(currentDate.getDate() + numberOfDaysToAdd);    function calendarBuilder() {        $('input[name="daterange"]').daterangepicker({            singleDatePicker: true,            showDropdowns: true,            minDate: currentDate,            maxDate: endDate        })    }}function mobileMapReturnHide() {    document.getElementById('map').style.display = "none";    document.getElementById('return').innerHTML = "";}function showOptions() {    document.getElementById('searchOnly').style = 'display:none';    document.getElementById('options').style.height = "auto";    document.getElementById('journeyPlan').style = 'display:block';}function hideOptions() {    document.getElementById('journeyPlan').style = 'display:none';    document.getElementById('options').style.height = "300px";    document.getElementById('searchOnly').style = 'display:block';}// Snap a user-created polyline to roads and draw the snapped pathfunction runSnapToRoad(path) {    var pathValues = [];    for (var i = 0; i < path.getLength(); i++) {        pathValues.push(path.getAt(i).toUrlValue());    }    $.get('https://roads.googleapis.com/v1/snapToRoads', {        interpolate: true,        key: 'AIzaSyC-hR-mSsuP9TGDFilrtWVmxNR_t1i-qYo',        path: pathValues.join('|')    }, function (data) {        processSnapToRoadResponse(data);        drawSnappedPolyline();    });}// Store snapped polyline returned by the snap-to-road service.function processSnapToRoadResponse(data) {    snappedCoordinates = [];    placeIdArray = [];    for (var i = 0; i < data.snappedPoints.length; i++) {        var latlng = new google.maps.LatLng(            data.snappedPoints[i].location.latitude,            data.snappedPoints[i].location.longitude);        snappedCoordinates.push(latlng);        placeIdArray.push(data.snappedPoints[i].placeId);    }}// Draws the snapped polyline (after processing snap-to-road response).function drawSnappedPolyline() {    var snappedPolyline = new google.maps.Polyline({        path: snappedCoordinates,        strokeColor: 'black',        strokeWeight: 3    });    snappedPolyline.setMap(map);    polylines.push(snappedPolyline);}// this function calls realtime api to get the real time infofunction get_real_time_data(id) {    if (document.getElementById('realtime' + id) == null) {        getJSON('https://data.smartdublin.ie/cgi-bin/rtpi/realtimebusinformation?stopid=' + id + '&format=json', function (err, datainfo) {            // realtime table head            var texthead = `<h6 style = "padding-left : 1%; font-size:15px; padding-top: 2%">Stop: ${datainfo.stopid}</h6>                            <p style = "padding-left : 1%;font-family:Tangerine; font-size:15px;">Data Refreshed at: ${datainfo.timestamp}</p>`            var text = `<table  style=" width:100%;  margin: auto; text-align: center; border: 1px solid black;border-collapse: collapse">                            <tr>                             <th style=" border: 1px solid #ddd; width: 20%;font-family:Tangerine; color: white;font-size:12px; background-color: #1C6EA4"; >Bus</th>                            <th style=" border: 1px solid #ddd; width: 50%;font-family:Tangerine; color: white;font-size:12px; background-color: #1C6EA4">Destination</th>                            <th style=" border: 1px solid #ddd; width: 30%;font-family:Tangerine; color: white;font-size:12px; background-color: #1C6EA4">Due</th>                            </tr></table>                            `            var content = "";            for (var i = 0, length = datainfo.results.length; i < length; i++) {                if (datainfo.results[i].duetime == 1) {                    var minute = "min";                } else if (datainfo.results[i].duetime == 'Due') {                    minute = "";                } else {                    minute = "mins";                }                // show realtime content                content += `<table style=" width: 100%; margin: auto; text-align: center; border: 1px solid black; border-collapse: collapse">                    <tr><td style=" border: 1px solid #ddd; width: 20%;font-family:Tangerine; font-size:12px;">${datainfo.results[i].route}</td>                    <td style=" border: 1px solid #ddd; width: 50%;font-family:Tangerine; font-size:12px;">${datainfo.results[i].destination}</td>                    <td style=" border: 1px solid #ddd; width: 30%;font-family:Tangerine; font-size:12px;">${datainfo.results[i].duetime}${minute}</td>                    </tr></table>`            }            document.getElementById("stop" + id).style.display = 'none';            $('#content' + id).append('<div id="realtime' + id + '">' + texthead + text + content + "</div>");            document.getElementById("realtime_p").innerHTML = "<img src='../static/img/back-icon.png' alt='back-icon' style='width: 10px; height: 10px'>";        });    } else if (document.getElementById("stop" + id).style.display === 'none') {        document.getElementById("stop" + id).style.display = 'block';        document.getElementById("realtime" + id).style.display = 'none';        document.getElementById("realtime_p").innerText = "Real Time Info";    } else {        document.getElementById("stop" + id).style.display = 'none';        document.getElementById("realtime" + id).style.display = 'block';        document.getElementById("realtime_p").innerHTML = "<img src='../static/img/back-icon.png' alt='back-icon' style='width: 10px; height: 10px'>";    }}function buildDateTime() {    var start = document.getElementById('origin-input').value;    var end = document.getElementById('destination-input').value;    if (start == "" || end == "") {        document.getElementById("options").innerHTML = "<h4 style = 'text-align: center'>Please enter a start and end location!</h4>" +            "<div style = 'text-align: center'>" +            "<br> <br> <button class='btn btn-primary' id = 'directionsButton'  type='submit' onclick = 'resetMap()'>Try Again</button> " +            "</div>";    } else {        document.getElementById('journeyPlan').style.display= 'none';        document.getElementById('timeDate').style.display= 'block';    }}var getJSON = function (url, callback) {    var xhr = new XMLHttpRequest();    xhr.open('GET', url, true);    xhr.responseType = 'json';    xhr.onload = function () {        var status = xhr.status;        if (status == 200) {            callback(null, xhr.response);        } else {            callback(status);        }    };    xhr.send();};function closestLocation(targetLocation, locationData) {    function vectorDistance(dx, dy) {        return Math.sqrt(dx * dx + dy * dy);    }    function locationDistance(location1, location2) {        var dx = location1.latitude - location2.latitude,            dy = location1.longitude - location2.longitude;        return vectorDistance(dx, dy);    }    return locationData.reduce(function (prev, curr) {        var prevDistance = locationDistance(targetLocation, prev),            currDistance = locationDistance(targetLocation, curr);        return (prevDistance < currDistance) ? prev : curr;    });}